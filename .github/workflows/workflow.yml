name: Upload SGHI FHIR Implentation Guide(IG) Resources To HAPI FHIR server

on: [push]

env:
  HAPI_FHIR_BASE_URL: ${{ secrets.HAPI_FHIR_BASE_URL }}

jobs:
  build-and-publish:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: [testing, staging, prod]

    environment:
      name: ${{ matrix.environment }}
    
    steps:
      - name: Check Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
        
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nodejs npm jq
          npm install -g fsh-sushi

      - name: Update sushi-config.yaml
        run: |
          echo "Replacing default canonical 'https://fhir.slade360.co.ke/fhir' with '${{ env.HAPI_FHIR_BASE_URL }}' in sushi-config.yaml"
          sed -i "s|https://fhir.slade360.co.ke/fhir|${{ env.HAPI_FHIR_BASE_URL }}|g" sushi-config.yaml
          echo "Updated sushi-config.yaml:"
          cat sushi-config.yaml

      - name: Run SUSHI Build
        run: |
          sushi -s .

      - name: Generate FHIR IG and Snapshots
        run: |
          echo "Generating FHIR Implementation Guide and snapshots..."
          ./_updatePublisher.sh
          ./_genonce.sh
          echo "IG generation and snapshot creation complete."
          
      - name: Publish FHIR Artifacts to HAPI FHIR
        run: |
          echo "Publishing to server: ${{ env.HAPI_FHIR_BASE_URL }}"
      
          for file in fsh-generated/resources/*.json; do
            if [ -f "$file" ]; then
              RESOURCE_TYPE=$(jq -r '.resourceType' "$file")
              RESOURCE_ID=$(jq -r '.id' "$file")
      
              # Only upload if it's a conformance resource
              if [ "$RESOURCE_TYPE" = "StructureDefinition" ] || \
                [ "$RESOURCE_TYPE" = "ValueSet" ] || \
                [ "$RESOURCE_TYPE" = "CodeSystem" ]; then
                
                echo "Uploading $file with resourceType=$RESOURCE_TYPE, id=$RESOURCE_ID"
                STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  -X PUT "${{ env.HAPI_FHIR_BASE_URL }}/${RESOURCE_TYPE}/${RESOURCE_ID}" \
                  -H "Content-Type: application/fhir+json" \
                  --data-binary "@$file")
      
                if [ "$STATUS_CODE" -lt 200 ] || [ "$STATUS_CODE" -ge 300 ]; then
                  echo "Error uploading $file. HTTP status code: $STATUS_CODE"
                  exit 1
                fi
              else
                echo "Skipping $file: resourceType $RESOURCE_TYPE is not a conformance/terminology resource."
              fi
            fi
          done
      
          echo "All conformance resources uploaded successfully."
      